pipeline {

    agent { label "jenkins-agent" }

    tools {
        terraform 'terraform'
        dockerTool 'docker'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timestamps()
        ansiColor('xtrem')
    }

    environment {
        DOCKERCOMPOSE_HOME = tool name: 'dockercompose', type: 'com.cloudbees.jenkins.plugins.customtools.CustomTool'
        AWS_ACCESS_KEY_ID = credentials('accessKey')
        AWS_SECRET_ACCESS_KEY = credentials('secretKey')
        GITHUB_TOKEN = credentials('github_pat')
        PROJECT_FOLDER_PATH = 'Calculator'
        PROJECT_DOCKER_FOLDER_PATH = 'deploy'
        HOME_AGENT = '/home/jenkins'
        GITHUB_USER = 'kpk666'
    }

    stages {
        stage('Create Dockerfile') {
            steps {
                dir(PROJECT_FOLDER_PATH) {
                    sh "docker build -t ghcr.io/kpk666/web-calculator:latest ."
                }
            }
        }

        stage('Push docker image to ghcr.io') {
            steps {
                dir(PROJECT_FOLDER_PATH) {
                    sh """
                    echo ${GITHUB_TOKEN} | docker login ghcr.io -u ${GITHUB} --password-stdin
                    docker push ghcr.io/kpk666/web-calculator:latest
                    """
                }
            }
        }      
    }
}